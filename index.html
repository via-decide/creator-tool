<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Decide Creator Tool</title>

  <!-- PWA -->
  <meta name="theme-color" content="#050505" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

  <!-- jsPDF + autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#050505;
      --panel:rgba(20,20,20,.94);
      --border:rgba(255,255,255,.10);
      --text:#fff;
      --muted:rgba(255,255,255,.65);
      --accent:#ff671f;
      --good:#00e676;
      --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 40% 10%, #111 0%, var(--bg) 60%);
      color:var(--text);
      font-family:var(--font);
      overflow:auto;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .top{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      margin-bottom:14px;flex-wrap:wrap
    }
    .badge{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:14px;
      border:1px solid rgba(255,103,31,.22);
      background:rgba(255,103,31,.08);
      font-weight:900;letter-spacing:.8px
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);box-shadow:0 0 12px rgba(0,230,118,.7)}
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 20px 70px rgba(0,0,0,.55);
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:8px;letter-spacing:.4px}
    input,textarea,select{
      width:100%;
      background:rgba(0,0,0,.35);
      border:1px solid var(--border);
      border-radius:14px;
      color:#fff;
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:190px;resize:vertical;line-height:1.5}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      letter-spacing:.6px;
      text-transform:uppercase;
      user-select:none;
    }
    .btn:active{transform:scale(.985);opacity:.92}
    .btn.primary{background:var(--accent);border:none;color:#000}
    .btn.good{background:rgba(0,230,118,.16);border-color:rgba(0,230,118,.35);color:var(--good)}
    .btn.warn{background:rgba(255,255,255,.05);border-color:rgba(255,103,31,.25);color:var(--accent)}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:var(--mono)}
    .out{
      background:rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px;
      overflow:auto;
      max-height:460px;
      white-space:pre-wrap;
      line-height:1.45;
      font-family:var(--mono);
      font-size:12.5px;
    }
    .toast{
      position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
      background:rgba(10,10,10,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:12px 16px;
      color:var(--good);
      font-family:var(--mono);
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s, transform .18s;
      z-index:99999;
    }
    .toast.on{opacity:1;transform:translateX(-50%) translateY(-10px)}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi span{
      font-family:var(--mono);font-size:12px;color:rgba(255,255,255,.7);
      padding:6px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
    }
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .miniGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:980px){ .miniGrid{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <!-- Install prompt bar -->
  <div id="pwa-install-bar" style="display:none;position:sticky;top:0;z-index:99999;background:rgba(0,0,0,.65);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08);padding:10px 14px;">
    <button id="btn-install" style="cursor:pointer;width:100%;padding:12px 14px;border-radius:14px;border:0;background:#ff671f;color:#000;font-weight:900;letter-spacing:.6px;text-transform:uppercase;">
      Install Decide Creator Tool
    </button>
  </div>

  <div class="wrap">
    <div class="top">
      <div class="badge"><span class="dot"></span> DECIDE CREATOR TOOL <span class="mono" style="opacity:.7">GOLD+VISUAL</span></div>
      <div class="kpi">
        <span id="sidKpi">SID: â€”</span>
        <span id="lenKpi">Text: â€”</span>
        <span id="healthKpi">Script: â€”</span>
      </div>
    </div>

    <div class="panel">
      <div class="grid">
        <div>
          <label>Topic</label>
          <input id="topic" placeholder="e.g. Overthinking decisions" />
        </div>

        <div class="miniGrid">
          <div>
            <label>Brand / Watermark (PDF)</label>
            <input id="watermark" value="DECIDE.ENGINE â€¢ INTERNAL â€¢ DO NOT REUPLOAD" />
          </div>
          <div>
            <label>Channel Name (text only)</label>
            <input id="channelName" value="decide.engine" />
          </div>
          <div>
            <label>Default Playlist Label</label>
            <select id="playlist">
              <option value="problems">Problems</option>
              <option value="solutions">Solutions</option>
            </select>
          </div>
          <div>
            <label>Visual Style Preset</label>
            <select id="visualPreset">
              <option value="studio">Dark Studio (default)</option>
              <option value="noir">Noir (hard shadows)</option>
              <option value="neon">Neon Edge (subtle glow)</option>
              <option value="minimal">Minimal (flat, clean)</option>
            </select>
          </div>
        </div>

        <div>
          <label>Problem input (your notes)</label>
          <textarea id="problem" placeholder="Paste problem research / story / bullets..."></textarea>
        </div>

        <div>
          <label>Solution input (your notes)</label>
          <textarea id="solution" placeholder="Paste solution framework / steps / payoff..."></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn primary" id="gen">Generate</button>
        <button class="btn good" id="copyAll">Copy YouTube Pack (Both)</button>
        <button class="btn" id="copyVisualProblem">Copy Visual Prompts (Problem)</button>
        <button class="btn" id="copyVisualSolution">Copy Visual Prompts (Solution)</button>
        <button class="btn warn" id="pdfProblem">PDF: Problem</button>
        <button class="btn warn" id="pdfSolution">PDF: Solution</button>
        <button class="btn warn" id="pdfCombined">PDF: Combined</button>
        <button class="btn" id="reset">Reset</button>
        <button class="btn" id="clearSaved">Clear Saved</button>
      </div>

      <div class="small" style="margin-top:10px">
        Output includes: Script + Visual prompts + Editor checklist. Autosaves drafts. Offline after first load.
      </div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:900;letter-spacing:.6px">GOLD SCRIPT â€” PROBLEM</div>
          <button class="btn" id="copyScriptProblem">Copy</button>
        </div>
        <div class="out" id="outProblem">(generate to view)</div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:900;letter-spacing:.6px">GOLD SCRIPT â€” SOLUTION</div>
          <button class="btn" id="copyScriptSolution">Copy</button>
        </div>
        <div class="out" id="outSolution">(generate to view)</div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:900;letter-spacing:.6px">VISUAL PROMPTS â€” PROBLEM</div>
          <button class="btn" id="copyVisualProblem2">Copy</button>
        </div>
        <div class="out" id="visualProblem">(generate to view)</div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:900;letter-spacing:.6px">VISUAL PROMPTS â€” SOLUTION</div>
          <button class="btn" id="copyVisualSolution2">Copy</button>
        </div>
        <div class="out" id="visualSolution">(generate to view)</div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:900;letter-spacing:.6px">YOUTUBE PACK â€” PROBLEM (A/B)</div>
          <button class="btn" id="copyYTProblem">Copy</button>
        </div>
        <div class="out" id="ytProblem">(generate to view)</div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:900;letter-spacing:.6px">YOUTUBE PACK â€” SOLUTION (A/B)</div>
          <button class="btn" id="copyYTSolution">Copy</button>
        </div>
        <div class="out" id="ytSolution">(generate to view)</div>
      </div>

      <div class="panel" style="grid-column:1 / -1">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:900;letter-spacing:.6px">EDITOR CHECKLIST (what to do with PDF script)</div>
          <button class="btn" id="copyChecklist">Copy</button>
        </div>
        <div class="out" id="checklist">(generate to view)</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   PWA INSTALL + SW
========================= */
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const bar = document.getElementById("pwa-install-bar");
  if (bar) bar.style.display = "block";
});
document.addEventListener("click", async (e) => {
  if (e.target && e.target.id === "btn-install") {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    const bar = document.getElementById("pwa-install-bar");
    if (bar) bar.style.display = "none";
  }
});
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try { await navigator.serviceWorker.register("/sw.js"); }
    catch (e) { console.warn("SW register failed", e); }
  });
}
</script>

<script>
/* =========================
   UTIL
========================= */
const $ = (id) => document.getElementById(id);
const toast = (m) => {
  const t = $("toast");
  t.textContent = m;
  t.classList.add("on");
  setTimeout(() => t.classList.remove("on"), 1700);
};
const SID = "SID-" + Math.random().toString(36).slice(2,6).toUpperCase();
$("sidKpi").textContent = "SID: " + SID;

function nowISO(){ return new Date().toISOString(); }
function wordCount(s){
  const m = String(s||"").trim().match(/\S+/g);
  return m ? m.length : 0;
}
async function copy(text){
  try{ await navigator.clipboard.writeText(text); toast("COPIED"); }
  catch{ prompt("Copy:", text); }
}
function cleanText(s){
  return String(s||"")
    .replace(/\r/g,"")
    .replace(/[ \t]+\n/g,"\n")
    .replace(/\n{3,}/g,"\n\n")
    .trim();
}
function lines(text){
  return cleanText(text).split("\n").map(x=>x.trim()).filter(Boolean);
}

/* =========================
   SAFE KEYPOINTS (prevents corruption)
========================= */
function keyPointsSafe(text, max=8){
  const arr = lines(text);
  if (!arr.length) return [];
  // Prefer short lines/bullets; fallback to sentence-like fragments
  const candidates = arr
    .map(x => x.replace(/^[-*â€¢]\s*/,""))
    .filter(x => x.length >= 18 && x.length <= 140);

  const uniq = [];
  const seen = new Set();
  for(const c of candidates){
    const k = c.toLowerCase();
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(c);
    if(uniq.length >= max) break;
  }

  // fallback
  if(!uniq.length){
    return [arr.slice(0, max).join(" ").slice(0,140)];
  }
  return uniq;
}

/* =========================
   GOLD SCRIPT (clean, structured)
========================= */
const SCENE_META = [
  { purpose:"Hook", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Slow (2 WPM)", duration:18 },
  { purpose:"Define the Problem", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Dynamic (220â€“260 WPM)", duration:45 },
  { purpose:"Escalate Stakes", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Slow (2 WPM)", duration:18 },
  { purpose:"Break the Illusion", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Dynamic (220â€“260 WPM)", duration:45 },
  { purpose:"Introduce Solution", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Slow (2 WPM)", duration:18 },
  { purpose:"Explain Mechanism", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Dynamic (220â€“260 WPM)", duration:45 },
  { purpose:"Simplify", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Slow (2 WPM)", duration:18 },
  { purpose:"Empower", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Dynamic (220â€“260 WPM)", duration:45 },
  { purpose:"Reframe", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Slow (2 WPM)", duration:18 },
  { purpose:"Identity Shift", curve:"Low â†’ Build â†’ Peak â†’ Drop", pace:"Dynamic (220â€“260 WPM)", duration:45 }
];

const TYPO_RULES = [
  "CAPS = full screen emphasis",
  "[brackets] = slight delay appearance",
  "Single-word line = isolated center",
  "\"â€¦\" = 0.5s pause"
];

function hookLine(topic, mode){
  const t = topic || "this";
  const hooksP = [
    `You think youâ€™re being carefulâ€¦`,
    `But ${t} isnâ€™t careful.`,
    `Itâ€™s quiet damage.`,
    `This is why you feel stuckâ€¦`
  ];
  const hooksS = [
    `You donâ€™t need more willpowerâ€¦`,
    `You need a repeatable move.`,
    `Hereâ€™s the system for ${t}.`,
    `No hype. Just control.`
  ];
  return (mode==="problem" ? hooksP : hooksS);
}

function punchLine(mode){
  return mode==="problem"
    ? ["Stop waiting for certainty.","This is the trap.","Delay is a decision.","Comfort is expensive."]
    : ["Small wins compound.","Choose. Then refine.","Systems beat moods.","Do it once. Repeat."];
}

function buildSceneScript({mode, topic, kp, idx}){
  const isSlow = (idx % 2 === 0);
  const hooks = hookLine(topic, mode);
  const punch = punchLine(mode);

  // Slow scenes: short, cinematic, clean typography behavior
  if(isSlow){
    const h = hooks[idx % hooks.length];
    const p = punch[idx % punch.length];
    return [
      `${h}`,
      `â€¦`,
      `You donâ€™t need more information.`,
      `You need`,
      `CONTROL.`,
      `â€¦`,
      `${p}`
    ].join("\n");
  }

  // Dynamic scenes: structured narrative, not random
  const base = mode==="problem"
    ? [
      `Every time you delay a decisionâ€¦`,
      `your brain calls it â€œbeing responsibleâ€.`,
      `But delay is protection.`,
      `Protection from regret.`,
      `Protection from responsibility.`,
      ``,
      `And it has a price:`,
      `Momentum dies quietly.`,
      `Confidence leaks.`,
      `Identity stays unfinished.`,
    ]
    : [
      `Hereâ€™s the method:`,
      `Make the smallest decision that creates feedback.`,
      `Then adjust.`,
      ``,
      `Donâ€™t aim for certainty.`,
      `Aim for evidence.`,
      `Evidence creates confidence.`,
      `Confidence creates speed.`,
    ];

  const insert = kp ? [
    ``,
    `Truth check:`,
    `â€œ${kp}â€`
  ] : [];

  const rehook = idx % 2 === 1 ? `Now watch thisâ€¦` : `Hereâ€™s the twistâ€¦`;
  const p = punch[(idx + 1) % punch.length];

  return [
    rehook,
    ``,
    ...base,
    ...insert,
    ``,
    p
  ].join("\n");
}

function buildGold({topic, mode, sourceText}){
  const kps = keyPointsSafe(sourceText, 8);
  const scenes = SCENE_META.map((m, idx) => {
    return {
      scene: idx+1,
      duration_s: m.duration,
      voice_pace: m.pace,
      energy_curve: m.curve,
      purpose: m.purpose,
      typography_notes: TYPO_RULES,
      script: buildSceneScript({mode, topic, kp: kps[idx % Math.max(1,kps.length)], idx})
    };
  });

  // Health check (basic)
  const all = scenes.map(s=>s.script).join("\n");
  const hasWeird = /undefined|null|\[object Object\]/i.test(all) || all.length < 200;
  $("healthKpi").textContent = hasWeird ? "Script: âš " : "Script: âœ…";

  return { topic, mode, created_at: nowISO(), scenes };
}

function goldToText(g){
  const header = [
    `TOPIC: ${g.topic}`,
    `MODE: ${g.mode.toUpperCase()}`,
    ``,
    `STYLE: Dark studio â€¢ White kinetic typography â€¢ Slow push-in â€¢ No stock footage`,
    `TYPOGRAPHY: ${TYPO_RULES.join(" | ")}`,
    ``,
  ].join("\n");

  const body = g.scenes.map(s => ([
    `SCENE ${s.scene}`,
    `Duration: ${s.duration_s}s`,
    `Voice Pace: ${s.voice_pace}`,
    `Energy Curve: ${s.energy_curve}`,
    `Purpose: ${s.purpose}`,
    `TYPO NOTES: ${s.typography_notes.join(" | ")}`,
    ``,
    `SCRIPT:`,
    s.script,
    ``,
    `---`,
    ``
  ].join("\n"))).join("\n");

  return header + body;
}

/* =========================
   VISUAL PROMPT GENERATOR (per-scene)
========================= */
function visualPresetText(preset){
  switch(preset){
    case "noir":
      return "Noir studio, hard shadows, high contrast, tight rim light, monochrome feel.";
    case "neon":
      return "Dark studio with subtle neon edge glow, soft haze, gentle bloom, cinematic contrast.";
    case "minimal":
      return "Minimal studio, flat clean lighting, no bloom, crisp text edges, calm framing.";
    default:
      return "Dark studio, soft rim light, cinematic contrast, subtle grain, slow push-in.";
  }
}

function visualForScene({topic, mode, scene, purpose, isSlow, preset}){
  const base = visualPresetText(preset);
  const cam = isSlow ? "Slow push-in 2â€“4% zoom" : "Micro push + subtle handheld drift (very low)";
  const typ = isSlow
    ? "Typography: 1â€“2 words at a time, big center, long holds, heavy pauses"
    : "Typography: kinetic emphasis on CAPS words, phrase-by-phrase reveals, 2â€“3 key punch words isolated";
  const pace = isSlow ? "Timing: 0.8â€“1.2s between words" : "Timing: 0.15â€“0.35s per phrase with 1â€“2 pattern interrupts";
  const sfx = isSlow ? "SFX: deep room tone, sub bass swell, soft hit on CAPS" : "SFX: light risers, click accents, bass hit on punchline";

  const modeTag = mode === "problem" ? "Tension / trap" : "Clarity / control";
  return [
    `SCENE ${scene} â€” ${purpose}`,
    `Mood: ${modeTag}`,
    `Look: ${base}`,
    `Camera: ${cam}`,
    `${typ}`,
    `${pace}`,
    `${sfx}`,
    `On-screen: reference topic = "${topic}"`
  ].join("\n");
}

function buildVisualPack(gold, preset){
  const blocks = gold.scenes.map((s, idx)=>{
    const isSlow = (idx % 2 === 0);
    return visualForScene({
      topic: gold.topic,
      mode: gold.mode,
      scene: s.scene,
      purpose: s.purpose,
      isSlow,
      preset
    });
  });
  return [
    `VISUAL PROMPT PACK`,
    `TOPIC: ${gold.topic}`,
    `MODE: ${gold.mode.toUpperCase()}`,
    `PRESET: ${preset.toUpperCase()}`,
    ``,
    blocks.join("\n\n---\n\n")
  ].join("\n");
}

/* =========================
   YOUTUBE PACK (no technical terms)
========================= */
function ytTitleVariants(topic, kind){
  const A = kind==="problem"
    ? `Youâ€™re Not Lazy â€” Youâ€™re Stuck in ${topic}`
    : `How to Break ${topic} (Without Forcing Motivation)`;
  const B = kind==="problem"
    ? `This is Why ${topic} Keeps Winning`
    : `The Simple System That Fixes ${topic}`;
  return { A, B };
}
function ytDescription(topic, kind){
  const base = kind==="problem"
    ? [
      `If ${topic} keeps looping in your head, this video will feel uncomfortably accurate.`,
      ``,
      `Youâ€™ll see the pattern, why it happens, and what it silently costs.`,
      ``,
      `If you want the fix, watch the next video in the series (Solution).`,
      ``,
      `ðŸ‘‡ Comment one sentence: what youâ€™re stuck on right now.`,
      ``,
      `#decide #focus #mindset`
    ]
    : [
      `This is the solution video for ${topic}.`,
      ``,
      `No hype. Just a repeatable method you can use even on low-energy days.`,
      ``,
      `Try it once today and come back with results.`,
      ``,
      `ðŸ‘‡ Comment: â€œDONEâ€ after you apply it.`,
      ``,
      `#decide #habits #focus`
    ];
  return base.join("\n");
}
function ytPinnedComment(topic, kind){
  const A = kind==="problem"
    ? `Whatâ€™s the ONE decision youâ€™re avoiding right now? Reply with a single sentence.`
    : `Pick ONE step from the video and do it today. Reply â€œDONEâ€ when finished.`;
  const B = kind==="problem"
    ? `If I made a Part 2 (Solution), what should it solve first?`
    : `Want a Part 3 with examples? Comment your situation (1â€“2 lines).`;
  return { A, B };
}
function ytCommunityPost(topic, kind){
  const A = kind==="problem"
    ? `Quick poll: when ${topic} hits, what do you do?\n\nA) Overthink\nB) Distract myself\nC) Ask someone\nD) Take action anyway`
    : `Todayâ€™s challenge: apply the solution to ${topic}.\n\nReply with:\nâœ… What you did\nâ±ï¸ How long it took\nðŸŽ¯ What changed`;
  const B = kind==="problem"
    ? `Be honest â€” whatâ€™s the real cost of ${topic} in your life right now?`
    : `If you could automate ONE habit to beat ${topic}, what would it be?`;
  return { A, B };
}
function youtubePackText(topic, kind){
  const titles = ytTitleVariants(topic, kind);
  const pins = ytPinnedComment(topic, kind);
  const comm = ytCommunityPost(topic, kind);
  return [
    `TYPE: ${kind.toUpperCase()}`,
    ``,
    `TITLE A: ${titles.A}`,
    `TITLE B: ${titles.B}`,
    ``,
    `DESCRIPTION:`,
    ytDescription(topic, kind),
    ``,
    `PINNED COMMENT A: ${pins.A}`,
    `PINNED COMMENT B: ${pins.B}`,
    ``,
    `COMMUNITY POST A:`,
    comm.A,
    ``,
    `COMMUNITY POST B:`,
    comm.B
  ].join("\n");
}

/* =========================
   EDITOR CHECKLIST (PDF script usage)
========================= */
function buildChecklist(topic){
  return [
    `EDITOR CHECKLIST â€” ${topic}`,
    ``,
    `1) Use the GOLD SCRIPT as the voiceover track.`,
    `2) Follow VISUAL PROMPT PACK scene-by-scene.`,
    `3) Typography rules:`,
    `   - CAPS words go full-screen`,
    `   - [brackets] appear slightly delayed`,
    `   - single-word lines hold longer`,
    `   - "â€¦" adds a 0.5 second pause`,
    `4) Add pattern interrupts every 30â€“45s (small zoom/shift/beat).`,
    `5) Keep background clean: dark studio only, no stock footage.`,
    `6) Add subtle room tone + bass hits on punchlines.`,
    `7) Export 2 thumbnails: one â€œProblemâ€, one â€œSolutionâ€.`,
    `8) Upload with Title A first; A/B test with Title B after 24h.`,
    `9) Pin comment A first; swap to B if engagement drops.`,
    `10) Community post: publish A at upload time, B the next day.`,
  ].join("\n");
}

/* =========================
   PDF EXPORT (includes script + visuals + checklist)
========================= */
function paintBg(doc){
  const w = doc.internal.pageSize.getWidth();
  const h = doc.internal.pageSize.getHeight();
  doc.setFillColor(5,5,5);
  doc.rect(0,0,w,h,"F");
}
function pdfWatermark(doc, text){
  const w = doc.internal.pageSize.getWidth();
  const h = doc.internal.pageSize.getHeight();
  try{ doc.setGState?.(new doc.GState({opacity:0.08})); }catch{}
  doc.setTextColor(255,103,31);
  doc.setFont("helvetica","bold");
  doc.setFontSize(34);
  doc.text(text, w/2, h/2, {align:"center", angle:35});
}
function writeWrapped(doc, text, x, y, maxW, lineH=12){
  doc.setFont("courier","normal");
  const lines = doc.splitTextToSize(String(text||""), maxW);
  for(const line of lines){
    const h = doc.internal.pageSize.getHeight();
    if(y > h-60){
      doc.addPage();
      paintBg(doc);
      y = 54;
    }
    doc.text(line, x, y);
    y += lineH;
  }
  return y;
}
function addFooter(doc, brand, sid, pageNum, total){
  const w = doc.internal.pageSize.getWidth();
  const h = doc.internal.pageSize.getHeight();
  doc.setFont("helvetica","normal");
  doc.setFontSize(9);
  doc.setTextColor(170);
  doc.text(`${brand} â€¢ ${sid}`, 44, h-18);
  doc.text(`Page ${pageNum}/${total}`, w-44, h-18, {align:"right"});
}

function exportPackagePdf({topic, kind, gold, visualPack, ytPack, checklist, watermarkText}){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt", format:"a4"});
  const w = doc.internal.pageSize.getWidth();
  const margin = 44;

  paintBg(doc); pdfWatermark(doc, watermarkText);
  doc.setTextColor(255,103,31);
  doc.setFont("helvetica","bold");
  doc.setFontSize(22);
  doc.text("SCRIPT PACKAGE", margin, 64);

  doc.setTextColor(255,255,255);
  doc.setFontSize(16);
  doc.text(topic, margin, 108);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  doc.setTextColor(180);
  doc.text(`Type: ${kind.toUpperCase()}`, margin, 130);
  doc.text(`Session: ${SID}`, margin, 146);
  doc.text(`Generated: ${nowISO()}`, margin, 162);

  // GOLD
  doc.addPage(); paintBg(doc); pdfWatermark(doc, watermarkText);
  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(255,255,255);
  doc.text(`GOLD SCRIPT â€” ${kind.toUpperCase()}`, margin, 60);
  doc.setFontSize(10); doc.setTextColor(220);
  let y = 86;
  y = writeWrapped(doc, goldToText(gold), margin, y, w - margin*2, 12);

  // VISUAL
  doc.addPage(); paintBg(doc); pdfWatermark(doc, watermarkText);
  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(255,255,255);
  doc.text(`VISUAL PROMPT PACK â€” ${kind.toUpperCase()}`, margin, 60);
  doc.setFontSize(10); doc.setTextColor(220);
  y = 86;
  y = writeWrapped(doc, visualPack, margin, y, w - margin*2, 12);

  // YT
  doc.addPage(); paintBg(doc); pdfWatermark(doc, watermarkText);
  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(255,255,255);
  doc.text(`YOUTUBE PACK â€” ${kind.toUpperCase()} (A/B)`, margin, 60);
  doc.setFontSize(10); doc.setTextColor(220);
  y = 86;
  y = writeWrapped(doc, ytPack, margin, y, w - margin*2, 12);

  // CHECKLIST
  doc.addPage(); paintBg(doc); pdfWatermark(doc, watermarkText);
  doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(255,255,255);
  doc.text(`EDITOR CHECKLIST`, margin, 60);
  doc.setFontSize(10); doc.setTextColor(220);
  y = 86;
  y = writeWrapped(doc, checklist, margin, y, w - margin*2, 12);

  const total = doc.getNumberOfPages();
  for(let p=1;p<=total;p++){
    doc.setPage(p);
    addFooter(doc, "DECIDE CREATOR TOOL", SID, p, total);
  }

  doc.save(`${topic.replace(/\s+/g,"_")}_${kind}_PACKAGE.pdf`);
}

/* =========================
   STATE + GENERATE
========================= */
let LAST = {
  topic:"",
  watermark:"",
  goldProblem:null,
  goldSolution:null,
  visualProblem:"",
  visualSolution:"",
  ytProblem:"",
  ytSolution:"",
  checklist:""
};

function generate(){
  const topic = cleanText($("topic").value) || "Untitled Topic";
  const wm = cleanText($("watermark").value) || "DECIDE.ENGINE â€¢ INTERNAL";
  const p = cleanText($("problem").value);
  const s = cleanText($("solution").value);
  const preset = $("visualPreset").value;

  if(!p && !s){ toast("Paste problem/solution text"); return; }

  $("lenKpi").textContent = `Text: ${wordCount(p)+wordCount(s)} words`;

  const goldProblem = buildGold({topic, mode:"problem", sourceText: p || topic});
  const goldSolution = buildGold({topic, mode:"solution", sourceText: s || topic});

  const vp = buildVisualPack(goldProblem, preset);
  const vs = buildVisualPack(goldSolution, preset);

  const ytP = youtubePackText(topic, "problem");
  const ytS = youtubePackText(topic, "solution");
  const cl = buildChecklist(topic);

  LAST = {
    topic, watermark: wm,
    goldProblem, goldSolution,
    visualProblem: vp,
    visualSolution: vs,
    ytProblem: ytP,
    ytSolution: ytS,
    checklist: cl
  };

  $("outProblem").textContent = goldToText(goldProblem);
  $("outSolution").textContent = goldToText(goldSolution);
  $("visualProblem").textContent = vp;
  $("visualSolution").textContent = vs;
  $("ytProblem").textContent = ytP;
  $("ytSolution").textContent = ytS;
  $("checklist").textContent = cl;

  toast("Generated âœ…");
  saveDraft();
}

$("gen").onclick = generate;

/* =========================
   COPY BUTTONS
========================= */
$("copyAll").onclick = async ()=>{
  if(!LAST.goldProblem) return toast("Generate first");
  await copy([
    `TOPIC: ${LAST.topic}`,
    `SID: ${SID}`,
    ``,
    `=== YOUTUBE PACK â€” PROBLEM ===`,
    LAST.ytProblem,
    ``,
    `=== YOUTUBE PACK â€” SOLUTION ===`,
    LAST.ytSolution
  ].join("\n"));
};

$("copyScriptProblem").onclick = async ()=> LAST.goldProblem ? copy(goldToText(LAST.goldProblem)) : toast("Generate first");
$("copyScriptSolution").onclick = async ()=> LAST.goldSolution ? copy(goldToText(LAST.goldSolution)) : toast("Generate first");
$("copyYTProblem").onclick = async ()=> LAST.ytProblem ? copy(LAST.ytProblem) : toast("Generate first");
$("copyYTSolution").onclick = async ()=> LAST.ytSolution ? copy(LAST.ytSolution) : toast("Generate first");

function copyVisualProblem(){ return LAST.visualProblem ? copy(LAST.visualProblem) : toast("Generate first"); }
function copyVisualSolution(){ return LAST.visualSolution ? copy(LAST.visualSolution) : toast("Generate first"); }

$("copyVisualProblem").onclick = copyVisualProblem;
$("copyVisualProblem2").onclick = copyVisualProblem;
$("copyVisualSolution").onclick = copyVisualSolution;
$("copyVisualSolution2").onclick = copyVisualSolution;

$("copyChecklist").onclick = async ()=> LAST.checklist ? copy(LAST.checklist) : toast("Generate first");

/* =========================
   PDF BUTTONS
========================= */
$("pdfProblem").onclick = ()=>{
  if(!LAST.goldProblem) return toast("Generate first");
  exportPackagePdf({
    topic: LAST.topic,
    kind: "problem",
    gold: LAST.goldProblem,
    visualPack: LAST.visualProblem,
    ytPack: LAST.ytProblem,
    checklist: LAST.checklist,
    watermarkText: LAST.watermark
  });
};

$("pdfSolution").onclick = ()=>{
  if(!LAST.goldSolution) return toast("Generate first");
  exportPackagePdf({
    topic: LAST.topic,
    kind: "solution",
    gold: LAST.goldSolution,
    visualPack: LAST.visualSolution,
    ytPack: LAST.ytSolution,
    checklist: LAST.checklist,
    watermarkText: LAST.watermark
  });
};

$("pdfCombined").onclick = ()=>{
  if(!LAST.goldProblem) return toast("Generate first");
  // Combined = export two packages quickly (simple + reliable)
  $("pdfProblem").click();
  setTimeout(()=> $("pdfSolution").click(), 350);
};

/* =========================
   RESET
========================= */
$("reset").onclick = ()=>{
  $("topic").value="";
  $("problem").value="";
  $("solution").value="";
  $("outProblem").textContent="(generate to view)";
  $("outSolution").textContent="(generate to view)";
  $("visualProblem").textContent="(generate to view)";
  $("visualSolution").textContent="(generate to view)";
  $("ytProblem").textContent="(generate to view)";
  $("ytSolution").textContent="(generate to view)";
  $("checklist").textContent="(generate to view)";
  LAST = { topic:"", watermark:"", goldProblem:null, goldSolution:null, visualProblem:"", visualSolution:"", ytProblem:"", ytSolution:"", checklist:"" };
  $("lenKpi").textContent="Text: â€”";
  $("healthKpi").textContent="Script: â€”";
  toast("Reset");
  saveDraft();
};

/* =========================
   AUTOSAVE
========================= */
const STORAGE_KEY = "decide_creator_tool_v2_gold_visual";
const AUTOSAVE_FIELDS = ["topic","watermark","channelName","playlist","visualPreset","problem","solution"];

function readField(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  if (el.tagName === "SELECT") return el.value;
  return el.value;
}
function writeField(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  if (el.tagName === "SELECT") el.value = val ?? "";
  else el.value = val ?? "";
}
function loadSavedDraft() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    AUTOSAVE_FIELDS.forEach((k) => writeField(k, data[k]));
    if (data && (data.topic || data.problem || data.solution)) toast("Draft restored âœ…");
  } catch (e) {
    console.warn("Draft restore failed", e);
  }
}
let saveTimer = null;
function scheduleSaveDraft() {
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(saveDraft, 300);
}
function saveDraft() {
  try {
    const payload = { updated_at: new Date().toISOString() };
    AUTOSAVE_FIELDS.forEach((k) => (payload[k] = readField(k)));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  } catch (e) { console.warn("Draft save failed", e); }
}
function clearDraft() {
  localStorage.removeItem(STORAGE_KEY);
  AUTOSAVE_FIELDS.forEach((k) => writeField(k, ""));
  $("outProblem").textContent="(generate to view)";
  $("outSolution").textContent="(generate to view)";
  $("visualProblem").textContent="(generate to view)";
  $("visualSolution").textContent="(generate to view)";
  $("ytProblem").textContent="(generate to view)";
  $("ytSolution").textContent="(generate to view)";
  $("checklist").textContent="(generate to view)";
  LAST = { topic:"", watermark:"", goldProblem:null, goldSolution:null, visualProblem:"", visualSolution:"", ytProblem:"", ytSolution:"", checklist:"" };
  $("lenKpi").textContent="Text: â€”";
  $("healthKpi").textContent="Script: â€”";
  toast("Saved draft cleared");
  saveDraft();
}
function initAutosave() {
  AUTOSAVE_FIELDS.forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("input", scheduleSaveDraft);
    el.addEventListener("change", scheduleSaveDraft);
  });
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") saveDraft();
  });
  const btn = document.getElementById("clearSaved");
  if (btn) btn.addEventListener("click", clearDraft);
  saveDraft();
}
window.addEventListener("load", () => {
  loadSavedDraft();
  initAutosave();
});
</script>
</body>
            </html>
